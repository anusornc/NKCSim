import streamlit as st
import numpy as np
import pandas as pd
from joblib import Parallel, delayed
import plotly.express as px

# ===============================
# 1. à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œà¸à¸·à¹‰à¸™à¸à¸²à¸™
# ===============================
N = 10
K_EFFECTUATION = 2
K_CAUSATION = 5
TIME_STEPS = 100
PRE_CHASM_STEPS = 16

# ===============================
# 2. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡ (à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¹à¸¥à¹‰à¸§)
# ===============================
def run_simulation(strategy_k, C, rho, threshold, seed):
    np.random.seed(seed)
    
    # 1. à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸•à¸±à¸§à¹à¸›à¸£à¸”à¹‰à¸§à¸¢ Normal Distribution (à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ 5)
    variables = np.random.normal(loc=5, scale=2, size=N)
    variables = np.clip(variables, 1, 9)
    
    # 2. à¹€à¸¥à¸·à¸­à¸à¸•à¸±à¸§à¹à¸›à¸£ K à¸•à¸±à¸§à¹à¸šà¸š Fix
    selected_vars = np.random.choice(N, strategy_k, replace=False)
    initial_mean = np.mean(variables[selected_vars])  # à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
    
    pre_adoption = 0
    post_adoption = 0
    
    for step in range(TIME_STEPS):
        if step > 0:
            # 3. à¸­à¸±à¸›à¹€à¸”à¸•à¸•à¸±à¸§à¹à¸›à¸£à¸”à¹‰à¸§à¸¢ Mean-Reverting Process
            noise = np.random.normal(0, scale=C, size=strategy_k)
            variables[selected_vars] = variables[selected_vars] * rho + \
                                       (1 - rho) * initial_mean + \
                                       noise * (1 - rho)
            variables = np.clip(variables, 1, 9)
        
        # 4. à¸„à¸³à¸™à¸§à¸“à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢
        avg = np.mean(variables[selected_vars])
        
        # 5. à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹€à¸à¸“à¸‘à¹Œ
        if avg >= threshold:
            if step < PRE_CHASM_STEPS:
                pre_adoption += 1
            else:
                post_adoption += 1
    
    return {
        'à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ': 'Effectuation' if strategy_k == K_EFFECTUATION else 'Causation',
        'K': strategy_k,
        'C': C,
        'rho': rho,
        'à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸š': threshold,
        'seed': seed,
        'à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸à¹ˆà¸­à¸™ Chasm (%)': round(pre_adoption / PRE_CHASM_STEPS * 100, 2),
        'à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸«à¸¥à¸±à¸‡ Chasm (%)': round(post_adoption / (TIME_STEPS - PRE_CHASM_STEPS) * 100, 2)
    }

# ===============================
# 3. à¸ªà¸£à¹‰à¸²à¸‡à¸«à¸™à¹‰à¸² UI à¸”à¹‰à¸§à¸¢ Streamlit
# ===============================
st.title("ğŸš€ NKC Model Simulation")

# ===============================
# à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™
# ===============================
st.markdown("""
### ğŸ“ à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™
- **à¸§à¸±à¸•à¸–à¸¸à¸›à¸£à¸°à¸ªà¸‡à¸„à¹Œ**: à¸ˆà¸³à¸¥à¸­à¸‡à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ **Effectuation (à¸›à¸£à¸±à¸šà¸•à¸±à¸§à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œ)** à¹à¸¥à¸° **Causation (à¸§à¸²à¸‡à¹à¸œà¸™à¸•à¸²à¸¡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢)** 
- **à¸›à¸±à¸ˆà¸ˆà¸±à¸¢à¸ªà¸³à¸„à¸±à¸**:
  - **à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡**: à¸„à¸§à¸šà¸„à¸¸à¸¡à¸”à¹‰à¸§à¸¢à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™ (C) à¹à¸¥à¸°à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡ (Ï)
  - **à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸š**: à¸à¸³à¸«à¸™à¸”à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸‚à¸±à¹‰à¸™à¸•à¹ˆà¸³à¸—à¸µà¹ˆà¸–à¸·à¸­à¸§à¹ˆà¸² "à¸¢à¸­à¸¡à¸£à¸±à¸šà¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡"
  - **à¸à¸²à¸£à¸ªà¸¸à¹ˆà¸¡**: à¹ƒà¸Šà¹‰ Random Seeds à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸‹à¹‰à¸³à¹„à¸”à¹‰
""")

st.markdown("""
### ğŸšï¸ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ
1. **à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ**:
   - **Effectuation (K=2)**: à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¹‰à¸­à¸¢ à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹à¸šà¸šà¸¢à¸·à¸”à¸«à¸¢à¸¸à¹ˆà¸™ à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¹„à¸¡à¹ˆà¹à¸™à¹ˆà¸™à¸­à¸™
   - **Causation (K=5)**: à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¡à¸²à¸ à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹à¸šà¸šà¸¡à¸µà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ à¹€à¸«à¸¡à¸²à¸°à¸à¸±à¸šà¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¹€à¸ªà¸–à¸µà¸¢à¸£

2. **à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™ (C)**:
   - **1 (à¸•à¹ˆà¸³)**: à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¸¡à¸µà¸„à¸§à¸²à¸¡à¹€à¸ªà¸–à¸µà¸¢à¸£
   - **7 (à¸›à¸²à¸™à¸à¸¥à¸²à¸‡)**: à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸›à¸²à¸™à¸à¸¥à¸²à¸‡
   - **9 (à¸ªà¸¹à¸‡)**: à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™à¹à¸¥à¸°à¸œà¸±à¸™à¸œà¸§à¸™à¸ªà¸¹à¸‡

3. **à¸ªà¸±à¸¡à¸›à¸£à¸°à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡ (Ï)**:
   - **0.1**: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¹€à¸£à¹‡à¸§ (à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¹„à¸¡à¹ˆà¹€à¸ªà¸–à¸µà¸¢à¸£)
   - **0.7**: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸›à¸²à¸™à¸à¸¥à¸²à¸‡
   - **0.9**: à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸Šà¹‰à¸² (à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¹€à¸ªà¸–à¸µà¸¢à¸£)

4. **à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸š**:
   - **5 (à¸•à¹ˆà¸³)**: à¸¢à¸­à¸¡à¸£à¸±à¸šà¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ â‰¥5
   - **6 (à¸›à¸²à¸™à¸à¸¥à¸²à¸‡)**: à¸¢à¸­à¸¡à¸£à¸±à¸šà¹€à¸¡à¸·à¹ˆà¸­à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ â‰¥6
   - **7 (à¸ªà¸¹à¸‡)**: à¸¢à¸­à¸¡à¸£à¸±à¸šà¹€à¸¡à¸·à¹ˆà¸­à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ â‰¥7

5. **Random Seeds**:  
   à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸¸à¹ˆà¸¡ (à¹€à¸Šà¹ˆà¸™ 42, 123, 789) à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸‹à¹‰à¸³à¹„à¸”à¹‰
""")


st.sidebar.header("à¸ªà¹ˆà¸§à¸™à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ")

# 3.1 à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ
st.sidebar.subheader("à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ")
strategies = st.sidebar.multiselect(
    "à¹€à¸¥à¸·à¸­à¸à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ",
    ["Effectuation", "Causation"],
    default=["Effectuation", "Causation"]
)
st.sidebar.caption("""
- **Effectuation (à¸›à¸£à¸±à¸šà¸•à¸±à¸§à¸•à¸²à¸¡à¸ªà¸–à¸²à¸™à¸à¸²à¸£à¸“à¹Œ)**: à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸™à¹‰à¸­à¸¢ (K=2) à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹à¸šà¸šà¸¢à¸·à¸”à¸«à¸¢à¸¸à¹ˆà¸™
- **Causation (à¸§à¸²à¸‡à¹à¸œà¸™à¸•à¸²à¸¡à¹€à¸›à¹‰à¸²à¸«à¸¡à¸²à¸¢)**: à¹ƒà¸Šà¹‰à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¡à¸²à¸ (K=5) à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹à¸šà¸šà¸¡à¸µà¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡
""")

# 3.2 à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œ
st.sidebar.subheader("à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œà¸«à¸¥à¸±à¸")
C_values = st.sidebar.multiselect(
    "à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸‹à¸±à¸šà¸‹à¹‰à¸­à¸™ (C)",
    [1,7,9],
    default=[1,7,9]
)
st.sidebar.caption("1=à¸•à¹ˆà¸³, 7=à¸›à¸²à¸™à¸à¸¥à¸²à¸‡, 9=à¸ªà¸¹à¸‡ (à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¸ à¸²à¸¢à¸™à¸­à¸)")

rho_values = st.sidebar.multiselect(
    "à¸ªà¸±à¸¡à¸›à¸£à¸°à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡ (rho)",
    [0.1,0.7,0.9],
    default=[0.1,0.7,0.9]
)
st.sidebar.caption("0.1=à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¹€à¸£à¹‡à¸§, 0.9=à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸Šà¹‰à¸²")

thresholds = st.sidebar.multiselect(
    "à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸š",
    [5,6,7],
    default=[5,6,7]
)
st.sidebar.caption("à¸„à¹ˆà¸²à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸‚à¸­à¸‡à¸•à¸±à¸§à¹à¸›à¸£à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰à¸–à¸·à¸­à¸§à¹ˆà¸² 'à¸¢à¸­à¸¡à¸£à¸±à¸š'")

seeds = st.sidebar.text_input(
    "Random Seeds (à¸„à¸±à¹ˆà¸™à¸”à¹‰à¸§à¸¢à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸«à¸¡à¸²à¸¢à¸ˆà¸¸à¸¥à¸ à¸²à¸„)",
    "42,123,789"
)
st.sidebar.caption("à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸ªà¸¸à¹ˆà¸¡ (à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸‹à¹‰à¸³à¹„à¸”à¹‰)")

# 3.3 à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸‚à¸±à¹‰à¸™à¸ªà¸¹à¸‡
with st.sidebar.expander("à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¸‚à¸±à¹‰à¸™à¸ªà¸¹à¸‡"):
    st.caption("à¸›à¸£à¸±à¸šà¸„à¹ˆà¸²à¹€à¸«à¸¥à¹ˆà¸²à¸™à¸µà¹‰à¹€à¸‰à¸à¸²à¸°à¹€à¸¡à¸·à¹ˆà¸­à¸ˆà¸³à¹€à¸›à¹‡à¸™")
    TIME_STEPS = st.number_input(
        "à¸ˆà¸³à¸™à¸§à¸™à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡",
        100
    )
    st.caption("à¸ˆà¸³à¸™à¸§à¸™à¸£à¸­à¸šà¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡ (à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™=100)")
    
    PRE_CHASM_STEPS = st.number_input(
        "à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¹ˆà¸­à¸™ Chasm",
        16
    )
    st.caption("à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸à¹ˆà¸­à¸™à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸™à¸§à¸±à¸•à¸à¸£à¸£à¸¡à¹à¸šà¸šà¸à¹‰à¸²à¸§à¸à¸£à¸°à¹‚à¸”à¸” (à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™=16)")

# 3.4 à¸›à¸¸à¹ˆà¸¡à¹€à¸£à¸´à¹ˆà¸¡à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡
st.sidebar.markdown("---")
if st.sidebar.button("à¹€à¸£à¸´à¹ˆà¸¡à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡"):
    # ... (à¹‚à¸„à¹‰à¸”à¹€à¸”à¸´à¸¡)
    # à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ UI
    seeds = [int(s) for s in seeds.split(",")]
    k_list = []
    if "Effectuation" in strategies:
        k_list.append(K_EFFECTUATION)
    if "Causation" in strategies:
        k_list.append(K_CAUSATION)
    
    # à¸ªà¸£à¹‰à¸²à¸‡à¸à¸²à¸£à¸²à¸¡à¸´à¹€à¸•à¸­à¸£à¹Œà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    params = []
    for k in k_list:
        for C in C_values:
            for rho in rho_values:
                for thresh in thresholds:
                    for seed in seeds:
                        params.append((k, C, rho, thresh, seed))
    
    # à¸£à¸±à¸™à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡à¹à¸šà¸šà¸‚à¸™à¸²à¸™
    with st.spinner("à¸à¸³à¸¥à¸±à¸‡à¸£à¸±à¸™à¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡..."):
        results = Parallel(n_jobs=-1)(delayed(run_simulation)(*p) for p in params)
    
    # à¸ªà¸£à¹‰à¸²à¸‡ DataFrame
    df = pd.DataFrame(results)
    summary = df.groupby(['à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ', 'C', 'rho', 'à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸š']).agg({
        'à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸à¹ˆà¸­à¸™ Chasm (%)': 'mean',
        'à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸«à¸¥à¸±à¸‡ Chasm (%)': 'mean'
    }).reset_index()
    
    # à¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ
    st.header("ğŸ“Š à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œà¸à¸²à¸£à¸ˆà¸³à¸¥à¸­à¸‡")
    st.dataframe(summary)
    
    # à¸ªà¸£à¹‰à¸²à¸‡à¸à¸£à¸²à¸Ÿà¸”à¹‰à¸§à¸¢ Plotly
    fig = px.line(
        summary,
        x="rho",
        y="à¸­à¸±à¸•à¸£à¸²à¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸šà¸«à¸¥à¸±à¸‡ Chasm (%)",
        color="à¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œ",
        facet_col="C",
        facet_row="à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸š",
        title="à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸¥à¸¢à¸¸à¸—à¸˜à¹Œà¸ à¸²à¸¢à¹ƒà¸•à¹‰à¸ªà¸ à¸²à¸à¹à¸§à¸”à¸¥à¹‰à¸­à¸¡à¸•à¹ˆà¸²à¸‡à¹†",
        labels={"rho": "à¸ªà¸±à¸¡à¸›à¸£à¸°à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡ (rho)"},
        hover_data=["C", "à¹€à¸à¸“à¸‘à¹Œà¸à¸²à¸£à¸¢à¸­à¸¡à¸£à¸±à¸š"]
    )
    st.plotly_chart(fig, use_container_width=True)

    # à¸­à¸™à¸¸à¸à¸²à¸•à¹ƒà¸«à¹‰à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    st.download_button(
        label="à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸›à¹‡à¸™ CSV",
        data=df.to_csv(index=False),
        file_name="simulation_results.csv",
        mime="text/csv"
    )